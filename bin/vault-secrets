#!/bin/bash
# vault-secrets - Manage encrypted secrets in Obsidian vault
# Usage: vault-secrets <command> [args]
# Commands:
#   list              - List all encrypted secrets
#   edit <project>    - Decrypt, edit in $EDITOR, re-encrypt
#   validate          - Test decryption of all secrets
#   info <project>    - Show metadata for a secret

set -e

VAULT_SECRETS="$HOME/Library/Mobile Documents/iCloud~md~obsidian/Documents/rhncrs-collab/9_System/Secrets"
COMMAND="$1"
PROJECT="$2"

# Helper: Get project list
get_projects() {
    if [ ! -d "$VAULT_SECRETS" ]; then
        return
    fi
    ls -1 "$VAULT_SECRETS"/*.env.enc 2>/dev/null | xargs -n1 basename | sed 's/.env.enc$//' | sort -u
}

# Command: list
cmd_list() {
    echo "üîê Encrypted Secrets in Vault:"
    echo ""

    if [ ! -d "$VAULT_SECRETS" ]; then
        echo "‚ö†Ô∏è  No secrets directory found"
        echo "   Expected: $VAULT_SECRETS"
        return
    fi

    local count=0
    for project in $(get_projects); do
        local ssh_file="$VAULT_SECRETS/${project}.env.enc"
        local pass_file="$VAULT_SECRETS/${project}.env.password.enc"
        local mod_date=$(stat -f "%Sm" -t "%Y-%m-%d" "$ssh_file" 2>/dev/null || echo "unknown")

        echo "${project}.env.enc                (Modified: $mod_date)"
        if [ -f "$pass_file" ]; then
            echo "  ‚îî‚îÄ ${project}.env.password.enc"
        fi
        count=$((count + 1))
    done

    echo ""
    echo "Total: $count projects"
}

# Command: edit
cmd_edit() {
    if [ -z "$PROJECT" ]; then
        echo "Usage: vault-secrets edit <project-name>"
        echo ""
        echo "Available projects:"
        get_projects | sed 's/^/  - /'
        exit 1
    fi

    local temp_file="/tmp/${PROJECT}.env.$$"

    # Decrypt to temp file
    echo "üîì Decrypting $PROJECT..."
    decrypt-env "$PROJECT" "$temp_file"

    # Edit
    ${EDITOR:-vim} "$temp_file"

    # Re-encrypt
    echo "üîê Re-encrypting..."
    encrypt-env "$PROJECT" "$temp_file"

    # Log change
    local log_file="$HOME/Library/Mobile Documents/iCloud~md~obsidian/Documents/rhncrs-collab/40_Logs/Daily_Notes/$(date +%Y-%m-%d).md"
    mkdir -p "$(dirname "$log_file")"
    echo "## Secrets Update - $(date '+%H:%M')" >> "$log_file"
    echo "‚úèÔ∏è Edited: ${PROJECT}.env" >> "$log_file"
    echo "" >> "$log_file"

    # Cleanup
    rm -f "$temp_file"

    echo "‚úÖ ${PROJECT} updated successfully"
}

# Command: validate
cmd_validate() {
    echo "üîç Validating all encrypted secrets..."
    echo ""

    local success_count=0
    local fail_count=0

    for project in $(get_projects); do
        echo -n "Testing $project... "
        if decrypt-env "$project" > /dev/null 2>&1; then
            echo "‚úÖ"
            success_count=$((success_count + 1))
        else
            echo "‚ùå FAILED"
            fail_count=$((fail_count + 1))
        fi
    done

    echo ""
    echo "Results: $success_count passed, $fail_count failed"

    if [ $fail_count -gt 0 ]; then
        exit 1
    fi
}

# Command: info
cmd_info() {
    if [ -z "$PROJECT" ]; then
        echo "Usage: vault-secrets info <project-name>"
        exit 1
    fi

    local ssh_file="$VAULT_SECRETS/${PROJECT}.env.enc"
    local pass_file="$VAULT_SECRETS/${PROJECT}.env.password.enc"

    if [ ! -f "$ssh_file" ]; then
        echo "‚ùå Project not found: $PROJECT"
        exit 1
    fi

    echo "üìä Secret Information: $PROJECT"
    echo ""
    echo "SSH-encrypted file:"
    echo "  Path:     $ssh_file"
    echo "  Size:     $(stat -f "%z bytes" "$ssh_file")"
    echo "  Modified: $(stat -f "%Sm" -t "%Y-%m-%d %H:%M:%S" "$ssh_file")"
    echo ""

    if [ -f "$pass_file" ]; then
        echo "Password-encrypted file:"
        echo "  Path:     $pass_file"
        echo "  Size:     $(stat -f "%z bytes" "$pass_file")"
        echo "  Modified: $(stat -f "%Sm" -t "%Y-%m-%d %H:%M:%S" "$pass_file")"
    else
        echo "‚ö†Ô∏è  No password-encrypted version found"
    fi
}

# Main command router
case "$COMMAND" in
    list)
        cmd_list
        ;;
    edit)
        cmd_edit
        ;;
    validate)
        cmd_validate
        ;;
    info)
        cmd_info
        ;;
    *)
        echo "Usage: vault-secrets <command> [args]"
        echo ""
        echo "Commands:"
        echo "  list              - List all encrypted secrets"
        echo "  edit <project>    - Decrypt, edit in \$EDITOR, re-encrypt"
        echo "  validate          - Test decryption of all secrets"
        echo "  info <project>    - Show metadata for a secret"
        echo ""
        echo "Examples:"
        echo "  vault-secrets list"
        echo "  vault-secrets edit infrastructure"
        echo "  vault-secrets validate"
        echo "  vault-secrets info rhinocrash"
        exit 1
        ;;
esac
