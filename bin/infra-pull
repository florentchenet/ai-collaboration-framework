#!/bin/bash
# infra-pull - Sync infrastructure state from VPS to Obsidian vault
# Usage: infra-pull [--force]
# Runs daily via launchd or manually

set -e

VPS="root@188.245.183.171"
VAULT_BASE="$HOME/Library/Mobile Documents/iCloud~md~obsidian/Documents/rhncrs-collab"
STATE_FILE="$VAULT_BASE/1_Projects/14_Infrastructure/CURRENT_STATE.md"
LOG_DIR="$VAULT_BASE/9_System/Logs/Daily_Notes"
LOG_FILE="$LOG_DIR/$(date +%Y-%m-%d).md"
SECRETS_DIR="$VAULT_BASE/9_System/Secrets"

# Create directories if needed
mkdir -p "$(dirname "$STATE_FILE")"
mkdir -p "$LOG_DIR"
mkdir -p "$SECRETS_DIR"

echo "ðŸ”„ Pulling infrastructure state from rhncrs.com VPS..."
echo ""

# Test SSH connection
if ! ssh -o BatchMode=yes -o ConnectTimeout=5 "$VPS" "echo 'SSH OK'" 2>/dev/null; then
    echo "âŒ SSH connection failed"
    echo ""
    echo "To fix:"
    echo "  1. Add your SSH key to VPS: ssh-copy-id $VPS"
    echo "  2. Or configure SSH key in ~/.ssh/config"
    echo ""
    echo "Example ~/.ssh/config:"
    echo "  Host rhncrs"
    echo "    HostName 188.245.183.171"
    echo "    User root"
    echo "    IdentityFile ~/.ssh/id_ed25519"
    echo ""
    exit 1
fi

echo "âœ… Connected to VPS"
echo ""

# Collect Docker state
echo "ðŸ“¦ Collecting Docker containers..."
DOCKER_STATE=$(ssh "$VPS" "docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}\t{{.Ports}}' 2>/dev/null" || echo "Docker not available")

# Collect system services
echo "âš™ï¸  Collecting system services..."
SERVICES=$(ssh "$VPS" "systemctl list-units --type=service --state=running | grep -E '(docker|nginx|rhino|node)' 2>/dev/null" || echo "No matching services")

# Collect Nginx config
echo "ðŸŒ Collecting Nginx status..."
NGINX_STATUS=$(ssh "$VPS" "nginx -t 2>&1 && echo '---' && ls -la /etc/nginx/sites-enabled/ 2>/dev/null" || echo "Nginx not configured")

# Find and encrypt .env files
echo "ðŸ” Collecting environment files..."
ENV_FILES=$(ssh "$VPS" "find /root -maxdepth 3 -name '.env' -type f 2>/dev/null" || echo "")

if [ -n "$ENV_FILES" ]; then
    while IFS= read -r env_path; do
        if [ -n "$env_path" ]; then
            project=$(basename "$(dirname "$env_path")")
            echo "   Found: $project/.env"

            # Download and encrypt
            scp -q "$VPS:$env_path" /tmp/pulled.env 2>/dev/null && \
            encrypt-env "$project" /tmp/pulled.env 2>/dev/null && \
            rm -f /tmp/pulled.env && \
            echo "   âœ… Encrypted: $project"
        fi
    done <<< "$ENV_FILES"
fi

# Generate CURRENT_STATE.md
echo ""
echo "ðŸ“ Generating state documentation..."

cat > "$STATE_FILE" << EOF
# Infrastructure Current State (rhncrs.com)

*Last Updated: $(date '+%Y-%m-%d %H:%M:%S')* (auto-generated by \`infra-pull\`)

---

## ðŸš€ Running Services

### Docker Containers

\`\`\`
$DOCKER_STATE
\`\`\`

### System Services

\`\`\`
$SERVICES
\`\`\`

---

## ðŸŒ Nginx Configuration

\`\`\`
$NGINX_STATUS
\`\`\`

---

## ðŸ” Environment Variables

Encrypted secrets stored in [[9_System/Secrets/README|Secrets]]:

$(vault-secrets list 2>/dev/null | grep -E '\.env\.enc' | sed 's/^/- /')

---

## ðŸ”§ Management

- **Update secrets:** \`vault-secrets edit <project>\`
- **Deploy to VPS:** \`infra-push <project>\`
- **Manual sync:** \`infra-pull\`

---

*Auto-synced daily at 9:00 AM*
EOF

# Log sync
if [ ! -f "$LOG_FILE" ]; then
    echo "# Daily Log - $(date '+%Y-%m-%d')" > "$LOG_FILE"
    echo "" >> "$LOG_FILE"
fi

cat >> "$LOG_FILE" << EOF

## Infrastructure Sync - $(date '+%H:%M')

âœ… Pulled latest state from rhncrs.com VPS
- Docker containers: $(echo "$DOCKER_STATE" | wc -l | tr -d ' ') found
- System services: $(echo "$SERVICES" | wc -l | tr -d ' ') running
- Environment files: Updated

EOF

echo "âœ… State documentation updated: $STATE_FILE"
echo "âœ… Log entry created: $LOG_FILE"

# Send notification (macOS only)
if command -v osascript &> /dev/null; then
    osascript -e 'display notification "Infrastructure synced successfully" with title "rhncrs.com" sound name "Glass"' 2>/dev/null || true
fi

echo ""
echo "ðŸŽ‰ Infrastructure sync complete!"
