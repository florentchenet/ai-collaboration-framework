#!/bin/bash
# encrypt-env - Encrypt .env file to Obsidian vault with dual encryption
# Usage: encrypt-env <project-name> <path-to-.env>
# Example: encrypt-env infrastructure /root/infrastructure/.env

set -e

PROJECT_NAME="$1"
ENV_FILE="$2"
VAULT_SECRETS="$HOME/Library/Mobile Documents/iCloud~md~obsidian/Documents/rhncrs-collab/9_System/Secrets"
SSH_KEY="$HOME/.ssh/id_ed25519.pub"

# Fallback to RSA if Ed25519 doesn't exist
if [ ! -f "$SSH_KEY" ]; then
    SSH_KEY="$HOME/.ssh/id_rsa.pub"
fi

# Validate inputs
if [ -z "$PROJECT_NAME" ] || [ -z "$ENV_FILE" ]; then
    echo "Usage: encrypt-env <project-name> <path-to-.env>"
    echo ""
    echo "Examples:"
    echo "  encrypt-env infrastructure /path/to/.env"
    echo "  encrypt-env rhinocrash ~/Dev/org/rhinocrash/.env"
    exit 1
fi

if [ ! -f "$ENV_FILE" ]; then
    echo "‚ùå Error: File not found: $ENV_FILE"
    exit 1
fi

if [ ! -f "$SSH_KEY" ]; then
    echo "‚ùå Error: SSH public key not found"
    echo "Expected: $SSH_KEY"
    echo ""
    echo "Generate one with: ssh-keygen -t ed25519 -C 'your_email@example.com'"
    exit 1
fi

# Create vault secrets directory if it doesn't exist
mkdir -p "$VAULT_SECRETS"

echo "üîê Encrypting $PROJECT_NAME environment variables..."
echo ""

# SSH key encryption
echo "üìù Step 1/2: Encrypting with SSH key..."
age -R "$SSH_KEY" -o "$VAULT_SECRETS/${PROJECT_NAME}.env.enc" "$ENV_FILE"
echo "   ‚úÖ Created: ${PROJECT_NAME}.env.enc"

# Password encryption
echo "üìù Step 2/2: Encrypting with master password..."
echo "   (You'll be prompted for the master password)"
age --passphrase -o "$VAULT_SECRETS/${PROJECT_NAME}.env.password.enc" "$ENV_FILE"
echo "   ‚úÖ Created: ${PROJECT_NAME}.env.password.enc"

echo ""
echo "‚úÖ Successfully encrypted to vault:"
echo "   SSH:      $VAULT_SECRETS/${PROJECT_NAME}.env.enc"
echo "   Password: $VAULT_SECRETS/${PROJECT_NAME}.env.password.enc"
echo ""
echo "üí° Tip: Use 'decrypt-env $PROJECT_NAME' to decrypt"
